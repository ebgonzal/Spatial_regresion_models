

# Definir función stepwise_forward (asegúrate de tenerla cargada)
stepwise_forward <- function(resp, data, criterio = "AIC", p_threshold = 0.05) {
  todas_vars <- c("Cob_est", "pob", "vincNBI", "preciom2", "Dist_CESAC")
  seleccionadas <- c()
  restantes <- todas_vars
  mejor_criterio <- Inf
  mejor_modelo <- NULL
  historial <- data.frame()
  
  while (length(restantes) > 0) {
    candidatos <- list()
    criterios <- c()
    p_vals <- c()
    
    for (var in restantes) {
      actual <- c(seleccionadas, var)
      f <- as.formula(paste(resp, "~", paste(actual, collapse = " + ")))
      mod <- glm(f, data = data, family = gaussian())
      
      candidatos[[var]] <- mod
      criterios <- c(criterios, ifelse(criterio == "AIC", AIC(mod), BIC(mod)))
      p_vals <- c(p_vals, summary(mod)$coefficients[var, "Pr(>|t|)"])
    }
    
    mejor_idx <- which.min(criterios)
    mejor_var <- restantes[mejor_idx]
    mejor_pval <- p_vals[mejor_idx]
    mejor_mod <- candidatos[[mejor_var]]
    mejor_valor <- criterios[mejor_idx]
    
    if (mejor_valor < mejor_criterio && mejor_pval < p_threshold) {
      seleccionadas <- c(seleccionadas, mejor_var)
      restantes <- setdiff(restantes, mejor_var)
      mejor_criterio <- mejor_valor
      mejor_modelo <- mejor_mod
      historial <- rbind(historial, data.frame(Variable = mejor_var,
                                               AIC = AIC(mejor_mod),
                                               BIC = BIC(mejor_mod),
                                               p_value = mejor_pval))
    } else {
      break
    }
  }
  
  return(list(variables = seleccionadas,
              modelo = mejor_modelo,
              resumen = historial))
}

# Vector con los índices de caries
vars_resp <- c("I_02", "I_36", "I_710", "I_1114", "I_06", "I_714", "I_314")

# Ejecutar stepwise para cada variable de caries
resultados_stepwise <- lapply(vars_resp, function(resp) {
  resultado <- stepwise_forward(resp, esc_final)
  list(
    indice = resp,
    seleccionadas = resultado$variables,
    resumen = resultado$resumen,
    modelo = resultado$modelo
  )
})
names(resultados_stepwise) <- vars_resp

# Mostrar resumen de variables seleccionadas por índice
for (res in resultados_stepwise) {
  cat("\n==============================\n")
  cat("Índice:", res$indice, "\n")
  cat("Variables seleccionadas:", paste(res$seleccionadas, collapse = ", "), "\n")
  print(res$resumen)
}



# Crear una tabla resumen combinada para todos los modelos
tabla_resumen <- do.call(rbind, lapply(resultados_stepwise, function(res) {
  if (nrow(res$resumen) == 0) {
    return(data.frame(
      Indice = res$indice,
      Paso = NA,
      Variable = NA,
      AIC = NA,
      BIC = NA,
      p_value = NA
    ))
  } else {
    res$resumen$Indice <- res$indice
    res$resumen$Paso <- seq_len(nrow(res$resumen))
    res$resumen[, c("Indice", "Paso", "Variable", "AIC", "BIC", "p_value")]
  }
}))

#write.csv(tabla_resumen, "stepwise_resultados.csv", row.names = FALSE)

